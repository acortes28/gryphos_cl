{% load static %}
{% load custom_filters %}

<style>
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    height: 100%;
  }
  
  .stats-card h3 {
    color: white;
    margin-bottom: 10px;
  }
  
  .stats-card .stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .stats-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  
  .table-responsive {
    border-radius: 10px;
    overflow: hidden;
  }
  
  .table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  .badge-stats {
    font-size: 0.8rem;
    padding: 4px 8px;
  }
  
  .estadisticas-evaluaciones-content,
  .estadisticas-estudiantes-content,
  .estadisticas-no-data-content {
    display: block !important;
  }
  
  /* Responsive improvements */
  @media (max-width: 768px) {
    .stats-card .stat-value {
      font-size: 1.5rem;
    }
    
    .stats-card .stat-label {
      font-size: 0.8rem;
    }
    
    .stats-card {
      padding: 15px;
    }
    
    .table th,
    .table td {
      font-size: 0.9rem;
      padding: 8px 6px;
    }
    
    .badge-stats {
      font-size: 0.7rem;
      padding: 3px 6px;
    }
  }
  
  @media (max-width: 576px) {
    .stats-card {
      padding: 12px;
    }
    
    .stats-card .stat-value {
      font-size: 1.3rem;
    }
    
    .table th,
    .table td {
      font-size: 0.8rem;
      padding: 6px 4px;
    }
    
    .badge-stats {
      font-size: 0.6rem;
      padding: 2px 4px;
    }
  }
</style>

<!-- Contenido de Estadísticas -->
<!-- Estadísticas Generales -->
{% if estadisticas %}
  <div class="row mb-4">
    <div class="col-12">
      <h4 class="mb-3">
        <i class="fas fa-chart-pie me-2"></i>Estadísticas Generales
      </h4>
      <div class="row g-3">
        <div class="col-6 col-md-3 mb-3">
          <div class="stats-card">
            <div class="stat-value">{{ estadisticas.promedio_general|floatformat:1|default:"N/A" }}</div>
            <div class="stat-label">Promedio General</div>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="stats-card">
            <div class="stat-value">{{ estadisticas.nota_minima|floatformat:1|default:"N/A" }}</div>
            <div class="stat-label">Nota Mínima</div>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="stats-card">
            <div class="stat-value">{{ estadisticas.nota_maxima|floatformat:1|default:"N/A" }}</div>
            <div class="stat-label">Nota Máxima</div>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="stats-card">
            <div class="stat-value">{{ estadisticas.total_estudiantes }}</div>
            <div class="stat-label">Total Estudiantes</div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}

<!-- Estadísticas por Evaluación -->
{% if estadisticas_evaluaciones %}
  <div class="estadisticas-evaluaciones-content">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
      <h4 class="mb-3 mb-md-0">
        <i class="fas fa-clipboard-list me-2"></i>Estadísticas por Evaluación
      </h4>
      <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
        <button onclick="window.location.href='{% url 'exportar_calificaciones_excel' curso.id %}'" class="btn btn-success btn-sm">
          <i class="fas fa-file-excel me-1"></i>Exportar Detallado
        </button>
        <button onclick="cargarCalificaciones()" class="btn btn-secondary btn-sm">
          <i class="fas fa-arrow-left me-1"></i>Volver a Calificaciones
        </button>
      </div>
    </div>
    <!-- Vista de tabla para pantallas grandes -->
    <div class="d-none d-lg-block">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Evaluación</th>
              <th>Tipo</th>
              <th>Fecha</th>
              <th>Calificaciones</th>
              <th>Promedio</th>
              <th>Mínima</th>
              <th>Máxima</th>
            </tr>
          </thead>
          <tbody>
            {% for stats in estadisticas_evaluaciones %}
              <tr>
                <td>
                  <strong>{{ stats.evaluacion.nombre }}</strong>
                  {% if stats.evaluacion.descripcion %}
                    <br><small class="text-muted">{{ stats.evaluacion.descripcion|truncatewords:10 }}</small>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-primary badge-stats">{{ stats.evaluacion.get_tipo_display }}</span>
                </td>
                <td>{{ stats.evaluacion.fecha_inicio|date:"d/m/Y" }} - {{ stats.evaluacion.fecha_fin|date:"d/m/Y" }}</td>
                <td>
                  <span class="badge bg-info badge-stats">{{ stats.total_calificaciones }}</span>
                </td>
                <td>
                  {% if stats.promedio %}
                    <span class="badge bg-success badge-stats">{{ stats.promedio|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-secondary badge-stats">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if stats.nota_minima %}
                    <span class="badge bg-warning badge-stats">{{ stats.nota_minima|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-secondary badge-stats">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if stats.nota_maxima %}
                    <span class="badge bg-info badge-stats">{{ stats.nota_maxima|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-secondary badge-stats">N/A</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Vista de cards para móviles y tablets -->
    <div class="d-lg-none">
      <div class="row g-3">
        {% for stats in estadisticas_evaluaciones %}
          <div class="col-12 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">{{ stats.evaluacion.nombre }}</h6>
                  <span class="badge bg-primary">{{ stats.evaluacion.get_tipo_display }}</span>
                </div>
                {% if stats.evaluacion.descripcion %}
                  <p class="text-muted small mb-2">{{ stats.evaluacion.descripcion|truncatewords:10 }}</p>
                {% endif %}
                <div class="row text-center g-2 mb-2">
                  <div class="col-4">
                    <small class="text-muted d-block">Calificaciones</small>
                    <span class="badge bg-info">{{ stats.total_calificaciones }}</span>
                  </div>
                  <div class="col-4">
                    <small class="text-muted d-block">Promedio</small>
                    {% if stats.promedio %}
                      <span class="badge bg-success">{{ stats.promedio|floatformat:1 }}</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </div>
                  <div class="col-4">
                    <small class="text-muted d-block">Mínima</small>
                    {% if stats.nota_minima %}
                      <span class="badge bg-warning">{{ stats.nota_minima|floatformat:1 }}</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </div>
                </div>
                <div class="row text-center g-2">
                  <div class="col-6">
                    <small class="text-muted d-block">Máxima</small>
                    {% if stats.nota_maxima %}
                      <span class="badge bg-info">{{ stats.nota_maxima|floatformat:1 }}</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </div>
                  <div class="col-6">
                    <small class="text-muted d-block">Fecha</small>
                    <small class="text-muted">{{ stats.evaluacion.fecha_inicio|date:"d/m/Y" }} - {{ stats.evaluacion.fecha_fin|date:"d/m/Y" }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<!-- Estadísticas por Estudiante -->
{% if estadisticas_estudiantes %}
  <div class="estadisticas-estudiantes-content">
    <h4 class="mb-3">
      <i class="fas fa-users me-2"></i>Estadísticas por Estudiante
    </h4>
    <!-- Vista de tabla para pantallas grandes -->
    <div class="d-none d-lg-block">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Estudiante</th>
              <th>Email</th>
              <th>Calificaciones</th>
              <th>Promedio</th>
              <th>Mínima</th>
              <th>Máxima</th>
            </tr>
          </thead>
          <tbody>
            {% for stats in estadisticas_estudiantes %}
              <tr>
                <td>
                  <strong>{{ stats.estudiante.get_full_name|default:stats.estudiante.username }}</strong>
                </td>
                <td>{{ stats.estudiante.email }}</td>
                <td>
                  <span class="badge bg-info badge-stats">{{ stats.total_calificaciones }}</span>
                </td>
                <td>
                  {% if stats.promedio %}
                    <span class="badge bg-success badge-stats">{{ stats.promedio|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-secondary badge-stats">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if stats.nota_minima %}
                    <span class="badge bg-warning badge-stats">{{ stats.nota_minima|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-secondary badge-stats">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if stats.nota_maxima %}
                    <span class="badge bg-info badge-stats">{{ stats.nota_maxima|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-secondary badge-stats">N/A</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Vista de cards para móviles y tablets -->
    <div class="d-lg-none">
      <div class="row g-3">
        {% for stats in estadisticas_estudiantes %}
          <div class="col-12 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">{{ stats.estudiante.get_full_name|default:stats.estudiante.username }}</h6>
                  <span class="badge bg-info">{{ stats.total_calificaciones }} calif.</span>
                </div>
                <p class="text-muted small mb-2">{{ stats.estudiante.email }}</p>
                <div class="row text-center g-2 mb-2">
                  <div class="col-4">
                    <small class="text-muted d-block">Promedio</small>
                    {% if stats.promedio %}
                      <span class="badge bg-success">{{ stats.promedio|floatformat:1 }}</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </div>
                  <div class="col-4">
                    <small class="text-muted d-block">Mínima</small>
                    {% if stats.nota_minima %}
                      <span class="badge bg-warning">{{ stats.nota_minima|floatformat:1 }}</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </div>
                  <div class="col-4">
                    <small class="text-muted d-block">Máxima</small>
                    {% if stats.nota_maxima %}
                      <span class="badge bg-info">{{ stats.nota_maxima|floatformat:1 }}</span>
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<!-- Mensaje si no hay datos -->
{% if not estadisticas and not estadisticas_evaluaciones and not estadisticas_estudiantes %}
  <div class="estadisticas-no-data-content text-center">
    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
    <h5 class="text-muted">No hay estadísticas disponibles</h5>
    <p class="text-muted">Las estadísticas aparecerán aquí una vez que se registren calificaciones en el curso.</p>
    <button onclick="cargarCalificaciones()" class="btn btn-primary">
      <i class="fas fa-arrow-left me-2"></i>Volver a Calificaciones
    </button>
  </div>
{% endif %} 