{% load static %}
{% csrf_token %}

<style>

  .badge.bg-info {
    color: #055160 !important;
  }
  .bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  .bg-gradient-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
  }
  .text-white {
    color: white !important;
  }
  
  /* Estilos para los grupos colapsables */
  .collapsible-header {
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }
  
  .collapsible-header:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
  }
  
  .collapsible-header .collapse-icon {
    transition: transform 0.3s ease;
    display: inline-block;
  }
  
  .collapsible-header.collapsed .collapse-icon {
    transform: rotate(-90deg);
  }
  
  .collapsible-header.expanded .collapse-icon {
    transform: rotate(0deg);
  }
  
  .collapsible-content {
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .collapsible-content.collapsed {
    max-height: 0;
    opacity: 0;
    padding: 0;
  }
  
  .collapsible-content.expanded {
    max-height: 1000px;
    opacity: 1;
    padding: 1rem;
  }
  
  /* Estilos para la tabla */
  .table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
  }
  
  .table td {
    vertical-align: middle;
    border-top: 1px solid #e9ecef;
  }
  
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  /* Estilos para los badges */
  .badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
  }
  
  /* Estilos para los botones de acción */
  .btn-group .btn {
    margin-right: 2px;
  }
  
  .btn-group .btn:last-child {
    margin-right: 0;
  }
</style>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4 ">
        <div>
          <button class="btn btn-outline-secondary btn-sm me-3" onclick="cargarRecursosContenido();">
            <i class="fas fa-arrow-left me-1"></i>Volver
          </button>
          <h4 class="mb-0">
            <i class="fas fa-book me-2"></i>Recursos de {{ evaluacion.nombre }}
          </h4>
        </div>
        {% if user.is_staff %}
        <button class="btn btn-primary" onclick="crearRecursoParaEvaluacion({{ evaluacion.id }});">
          <i class="fas fa-plus me-2"></i>Agregar Recurso
        </button>
        {% endif %}
      </div>
      
      {% if recursos %}
        <!-- Agrupar recursos por tipo -->
        {% regroup recursos by tipo as recursos_por_tipo %}
        
        {% for tipo in recursos_por_tipo %}
          <div class="card mb-4">
            <div class="card-header bg-gradient-primary text-white collapsible-header collapsed" 
                 onclick="toggleCollapse('collapse-{{ forloop.counter }}', this)"
                 data-bs-toggle="collapse" 
                 data-bs-target="#collapse-{{ forloop.counter }}"
                 aria-expanded="true"
                 aria-controls="collapse-{{ forloop.counter }}">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white">
                  <i class="fas fa-folder me-2 text-white"></i>
                  <i class="fas fa-chevron-down collapse-icon me-2"></i>
                  {{ tipo.grouper|title }}
                  <span class="badge bg-light text-dark ms-2">{{ tipo.list|length }}</span>
                </h5>
                <small class="text-white-50">Haz clic para colapsar/expandir</small>
              </div>
            </div>
            <div class="card-body p-0 collapsible-content collapsed" id="collapse-{{ forloop.counter }}">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 30%;">Nombre</th>
                      <th style="width: 25%;">Descripción</th>
                      <th style="width: 15%;">Fecha de Creación</th>
                      <th style="width: 15%;">Archivo/Enlace</th>
                      <th style="width: 15%;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for recurso in tipo.list %}
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="{{ recurso.get_icono_tipo }} me-2 text-info"></i>
                          <strong>{{ recurso.nombre }}</strong>
                        </div>
                      </td>
                      <td>
                        <small class="text-muted">
                          {{ recurso.descripcion|truncatewords:15 }}
                        </small>
                      </td>
                      <td>
                        <small class="text-muted">
                          <i class="fas fa-calendar me-1"></i>
                          {{ recurso.fecha_creacion|date:"d/m/Y H:i" }}
                        </small>
                      </td>
                      <td>
                        {% if recurso.tiene_archivo %}
                          <div class="d-flex align-items-center">
                            <i class="fas fa-file me-1 text-success"></i>
                            <small class="text-muted">
                              {{ recurso.get_nombre_archivo }}
                              {% if recurso.get_tamano_archivo %}
                                <br><span class="badge bg-secondary">{{ recurso.get_tamano_archivo }}</span>
                              {% endif %}
                            </small>
                          </div>
                        {% elif recurso.tiene_enlace %}
                          <div class="d-flex align-items-center">
                            <i class="fas fa-link me-1 text-primary"></i>
                            <small class="text-muted">Enlace externo</small>
                          </div>
                        {% else %}
                          <span class="text-muted small">-</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          {% if recurso.tiene_archivo %}
                            <a href="{{ recurso.archivo_adjunto.url }}" class="btn btn-outline-primary btn-sm" target="_blank" title="Descargar">
                              <i class="fas fa-download"></i>
                            </a>
                          {% endif %}
                          
                          {% if recurso.tiene_enlace %}
                            <a href="{{ recurso.enlace_externo }}" class="btn btn-outline-info btn-sm" target="_blank" title="Ver Enlace">
                              <i class="fas fa-external-link-alt"></i>
                            </a>
                          {% endif %}
                          
                          {% if user.is_staff %}
                            <button class="btn btn-outline-warning btn-sm" onclick="editarRecurso({{ recurso.id }});" title="Editar">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarRecurso({{ recurso.id }}, '{{ recurso.nombre }}');" title="Eliminar">
                              <i class="fas fa-trash"></i>
                            </button>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endfor %}
        
      {% else %}
        <div class="text-center py-5">
          <i class="fas fa-book fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No hay recursos disponibles para esta evaluación</h5>
          <p class="text-muted">Los recursos aparecerán aquí cuando sean agregados por los administradores.</p>
          {% if user.is_staff %}
          <button class="btn btn-primary" onclick="crearRecursoParaEvaluacion({{ evaluacion.id }});">
            <i class="fas fa-plus me-2"></i>Crear Primer Recurso
          </button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Función para alternar el estado colapsable
function toggleCollapse(collapseId, headerElement) {
  const content = document.getElementById(collapseId);
  const isExpanded = content.classList.contains('expanded');
  
  if (isExpanded) {
    // Colapsar
    content.classList.remove('expanded');
    content.classList.add('collapsed');
    headerElement.classList.remove('expanded');
    headerElement.classList.add('collapsed');
  } else {
    // Expandir
    content.classList.remove('collapsed');
    content.classList.add('expanded');
    headerElement.classList.remove('collapsed');
    headerElement.classList.add('expanded');
  }
}

// Inicializar todos los grupos como expandidos por defecto
document.addEventListener('DOMContentLoaded', function() {
  const headers = document.querySelectorAll('.collapsible-header');
  headers.forEach(header => {
    header.classList.add('collapsed');
  });
});
</script>

 