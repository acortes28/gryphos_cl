{% extends 'pages/plataforma_aprendizaje.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Calificaciones - {{ curso.nombre }} - Plataforma de Aprendizaje{% endblock title %}

{% block content %}
{{ block.super }}

<script>
// Sobrescribir la función cambiarSeccion para manejar las calificaciones
function cambiarSeccion(seccion) {
  if (seccion === 'calificaciones') {
    // Cargar el contenido de calificaciones dinámicamente
    cargarCalificaciones();
  } else {
    // Llamar a la función original para otras secciones
    cambiarSeccionOriginal(seccion);
  }
}

// Función original de cambiarSeccion (guardada como referencia)
function cambiarSeccionOriginal(seccion) {
  // Mostrar loading
  document.getElementById('loading').classList.add('show');
  
  // Ocultar todas las secciones
  document.querySelectorAll('.section-content').forEach(el => {
    el.classList.remove('active');
  });
  
  // Actualizar navegación
  document.querySelectorAll('.nav-link').forEach(el => {
    el.classList.remove('active');
  });
  
  // Activar enlace correspondiente
  document.querySelector(`[data-seccion="${seccion}"]`).classList.add('active');
  
  // Actualizar título
  const config = PLATAFORMA_CONFIG.secciones[seccion];
  const titleElement = document.getElementById('section-title');
  titleElement.innerHTML = `<i class="${config.icono} me-2"></i>${config.titulo}`;
  
  // Simular carga (en producción esto sería una petición AJAX)
  setTimeout(() => {
    // Mostrar sección correspondiente
    document.getElementById(`seccion-${seccion}`).classList.add('active');
    
    // Ocultar loading
    document.getElementById('loading').classList.remove('show');
    
    // Actualizar URL sin recargar
    const url = new URL(window.location);
    url.searchParams.set('seccion', seccion);
    window.history.pushState({}, '', url);
  }, 300);
}

// Función para cargar el contenido de calificaciones
function cargarCalificaciones() {
  const seccionCalificaciones = document.getElementById('seccion-calificaciones');
  
  // Mostrar loading
  document.getElementById('loading').classList.add('show');
  
  // Ocultar todas las secciones
  document.querySelectorAll('.section-content').forEach(el => {
    el.classList.remove('active');
  });
  
  // Actualizar navegación
  document.querySelectorAll('.nav-link').forEach(el => {
    el.classList.remove('active');
  });
  
  // Activar enlace de calificaciones
  document.querySelector('[data-seccion="calificaciones"]').classList.add('active');
  
  // Actualizar título
  const titleElement = document.getElementById('section-title');
  titleElement.innerHTML = '<i class="fas fa-chart-line me-2"></i>Calificaciones';
  
  // Limpiar parámetros de sección de la URL
  const url = new URL(window.location);
  url.searchParams.delete('seccion');
  window.history.replaceState({}, '', url);
  
  // Cargar contenido de calificaciones vía AJAX
  fetch(`{% url 'plataforma_calificaciones_ajax' curso.id %}`, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.html) {
        seccionCalificaciones.innerHTML = data.html;
      }
      
      // Mostrar sección de calificaciones
      seccionCalificaciones.classList.add('active');
      
      // Ocultar loading
      document.getElementById('loading').classList.remove('show');
    })
    .catch(error => {
      console.error('Error cargando calificaciones:', error);
      document.getElementById('loading').classList.remove('show');
    });
}

// Event listeners para navegación
document.addEventListener('DOMContentLoaded', function() {
  // Navegación del sidebar
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const seccion = this.getAttribute('data-seccion');
      cambiarSeccion(seccion);
    });
  });
  
  // Limpiar parámetros de sección de la URL si estamos en calificaciones
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('seccion')) {
    urlParams.delete('seccion');
    const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
    window.history.replaceState({}, '', newUrl);
  }
  
  // Si estamos en la página de calificaciones, mostrar el contenido directamente
  if (window.location.pathname.includes('/plataforma/calificaciones/')) {
    // Marcar calificaciones como activo
    document.querySelector('[data-seccion="calificaciones"]').classList.add('active');
    
    // Actualizar título
    const titleElement = document.getElementById('section-title');
    titleElement.innerHTML = '<i class="fas fa-chart-line me-2"></i>Calificaciones';
    
    // Mostrar sección de calificaciones
    const seccionCalificaciones = document.getElementById('seccion-calificaciones');
    seccionCalificaciones.classList.add('active');
    
    // Cargar contenido de calificaciones
    cargarCalificaciones();
  } else {
    // Inicializar con la sección activa desde la URL
    const seccionActiva = urlParams.get('seccion') || 'inicio';
    cambiarSeccion(seccionActiva);
  }
});

// Manejar navegación del navegador (botones atrás/adelante)
window.addEventListener('popstate', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const seccionActiva = urlParams.get('seccion') || 'inicio';
  cambiarSeccion(seccionActiva);
});
</script>
{% endblock content %} 