{% load static %}
{% load custom_filters %}

<!-- Contenido específico para editar rúbrica -->
<div id="seccion-editar-rubrica" class="section-content active">
  <div class="row">
    <!-- Información de la Rúbrica -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0 text-white">
            <i class="fas fa-clipboard-list me-2"></i>Información de la Rúbrica
          </h4>
        </div>
        <div class="card-body">
          {% if mensaje_restriccion %}
            <div class="alert alert-warning" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>{{ mensaje_restriccion }}
            </div>
          {% endif %}
          
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            
            <div class="form-group">
              <label for="nombre" class="form-label required-field">Nombre de la Rúbrica</label>
              <input type="text" class="form-control" id="nombre" name="nombre" autocomplete="off"
                     value="{{ rubrica.nombre }}" required {% if not puede_editar %}disabled{% endif %}>
              <small class="form-text text-muted">Nombre descriptivo que identifique la rúbrica</small>
            </div>
            <label for="nombre" class="form-label required-field">Objetivos de Aprendizaje</label>
            
            <div class="card-body">
              <div id="objetivos-container">
                {% if rubrica.objetivos_aprendizaje.all %}
                  {% for objetivo in rubrica.objetivos_aprendizaje.all %}
                    <div class="objetivo-item mb-3 p-3 border rounded" id="objetivo_{{ objetivo.id }}">
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group mb-2">
                            <label class="form-label small">Nombre del Objetivo</label>
                            <input type="text" class="form-control form-control-sm" 
                                   name="objetivos[{{ objetivo.id }}][nombre]" 
                                   value="{{ objetivo.nombre }}" 
                                   placeholder="Ej: Comprensión conceptual" 
                                   {% if not puede_editar %}disabled{% endif %} required>
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="form-group mb-2">
                            <label class="form-label small">Descripción</label>
                            <textarea class="form-control form-control-sm" rows="2" 
                                      name="objetivos[{{ objetivo.id }}][descripcion]" 
                                      placeholder="Descripción del objetivo" 
                                      {% if not puede_editar %}disabled{% endif %} required>{{ objetivo.descripcion }}</textarea>
                          </div>
                        </div>
                      </div>
                      {% if puede_editar %}
                        <div class="text-end">
                          <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarObjetivo({{ objetivo.id }})">
                            <i class="fas fa-trash me-1"></i>Eliminar
                          </button>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-center py-4">
                    <i class="fas fa-bullseye fa-2x text-muted mb-3"></i>
                    <p class="text-muted">No hay objetivos de aprendizaje configurados</p>
                  </div>
                {% endif %}
              </div>
              
                      {% if puede_editar %}
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="abrirModalObjetivo()">
                          <i class="fas fa-plus me-1"></i>Agregar Objetivo de Aprendizaje
                        </button>
                        <small class="form-text text-muted d-block mt-2">
                          <i class="fas fa-info-circle me-1"></i>
                          Los objetivos de aprendizaje se pueden asociar a los criterios de evaluación
                        </small>
                      {% endif %}
            </div>
            
            <div class="d-flex justify-content-between">
              <button type="button" onclick="cargarCalificaciones()" class="btn btn-primary">
                <i class="fas fa-arrow-left me-1"></i>Volver
              </button>
              {% if puede_editar %}
                <button type="button" class="btn btn-primary" onclick="guardarCambiosRubrica()">
                  <i class="fas fa-save me-1"></i>Guardar Cambios
                </button>
              {% else %}
                <button type="button" class="btn btn-secondary" disabled>
                  <i class="fas fa-lock me-1"></i>No Editable
                </button>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Criterios de la Rúbrica -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0 text-white">
            <i class="fas fa-list-check me-2 text-white"></i>Criterios
          </h5>
        </div>
        <div class="card-body">
          {% if rubrica.criterios.all %}
            <div class="criterios-list">
              {% for criterio in rubrica.criterios.all %}
                <div class="criterio-item mb-3 p-3 border rounded">
                  <h6 class="mb-2">{{ criterio.nombre }}</h6>
                  <p class="text-muted small mb-2">{{ criterio.objetivo|truncatewords:20 }}</p>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">{{ criterio.esperables.count }} esperables</small>
                    <span class="badge bg-primary">{% if criterio.puntaje %}{{ criterio.puntaje|puntaje_entero }}{% else %}0{% endif %} puntos</span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group btn-group-sm">
                      {% if puede_editar %}
                        <button class="btn btn-outline-primary btn-sm" onclick="editarCriterio({{ criterio.id }})">
                          <i class="fas fa-edit"></i>Editar
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="eliminarCriterio({{ criterio.id }})">
                          <i class="fas fa-trash"></i>Eliminar
                        </button>
                      {% else %}
                        <button class="btn btn-outline-secondary btn-sm" disabled>
                          <i class="fas fa-lock"></i>No Editable
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div id="no-criterios" class="text-center py-4">
              <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
              <p class="text-muted">No hay criterios agregados</p>
            </div>
          {% endif %}
          
          {% if puede_editar %}
            <button class="btn btn-success w-100" onclick="abrirModalAgregarCriterio()">
              <i class="fas fa-plus me-2"></i>Agregar Criterio
            </button>
          {% else %}
            <button class="btn btn-secondary w-100" disabled>
              <i class="fas fa-lock me-2"></i>No Se Pueden Agregar Criterios
            </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

<!-- Incluir los modales y scripts necesarios -->
{% include 'pages/editar_rubrica_modals.html' %}

<script>
// Inicializar objetivos existentes cuando se cargue la página
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar objetivos existentes usando la función del template padre
  if (typeof window.inicializarObjetivosExistentes === 'function') {
    window.inicializarObjetivosExistentes();
  }
});
</script>

<style>
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    font-weight: 600;
    color: #344767;
    margin-bottom: 8px;
  }
  
  .form-control {
    border-radius: 8px;
    border: 1px solid #e9ecef;
    padding: 12px 16px;
    transition: all 0.3s ease;
  }
  
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }
  
  .card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0 !important;
    padding: 20px 25px;
  }
  
  .card-body {
    padding: 25px;
  }
  
  .required-field::after {
    content: " *";
    color: #dc3545;
  }
  
  .criterio-item {
    background: #f8f9fa;
    transition: all 0.3s ease;
  }
  
  .criterio-item:hover {
    background: #e9ecef;
    transform: translateY(-1px);
  }
  
  /* Estilos para objetivos de aprendizaje */
  .objetivo-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6 !important;
    transition: all 0.3s ease;
  }
  
  .objetivo-item:hover {
    background-color: #e9ecef;
    border-color: #adb5bd !important;
  }
  
  .objetivo-item .form-control-sm {
    font-size: 13px;
    padding: 8px 12px;
  }
  
  .objetivo-item .btn-sm {
    font-size: 12px;
    padding: 6px 12px;
  }
  
  /* Estilos para el select de objetivos en el modal */
  .form-select {
    border-radius: 8px;
    border: 2px solid #d1d5db;
    padding: 12px 16px;
    transition: all 0.3s ease;
    background-color: #ffffff;
    font-size: 14px;
    line-height: 1.5;
  }
  
  .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    outline: none;
  }
</style> 